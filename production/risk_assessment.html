<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Risk Register - RISQIANT</title>
    <script type="module" src="/src/main-minimal-modern.js"></script>
    <style>
      .heatmap-cell {
        height: 80px;
        color: white;
        text-align: center;
        vertical-align: middle;
        font-weight: bold;
        border: 1px solid #fff;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      .heatmap-cell:hover { opacity: 0.8; }
      .bg-critical { background-color: #E74C3C; }
      .bg-high { background-color: #E67E22; }
      .bg-medium { background-color: #F39C12; }
      .bg-low { background-color: #1ABB9C; }
    </style>
  </head>

  <body class="nav-md page-index">
    <div class="container body">
      <div class="main_container">
        <!-- Sidebar -->
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index.html" class="site_title"><img src="images/logo.svg" alt="RISQIANT" class="logo-full" style="height: 40px;"><img src="images/logo-icon.svg" alt="RISQIANT" class="logo-icon" style="height: 30px; display: none;"></a>
            </div>
            <div class="clearfix"></div>
            <div class="profile clearfix">
              <div class="profile_pic">
                <img src="images/img.jpg" alt="..." class="img-circle profile_img">
              </div>
              <div class="profile_info">
                <span>Welcome,</span>
                <h4>Admin User</h4>
              </div>
            </div>
            <br />
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                  <li><a><i class="fas fa-shield-alt"></i> Risk Assessment <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu" style="display: block;">
                        <li><a href="attack_surface.html">Attack Surface</a></li>
                        <li><a href="vulnerabilities.html">Vulnerabilities</a></li>
                        <li class="current-page"><a href="risk_assessment.html">Risk Register</a></li>
                    </ul>
                  </li>
                  <li><a><i class="fas fa-check-circle"></i> Compliance <span class="fas fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="compliance_soc2.html">SOC 2</a></li>
                      <li><a href="compliance_pci.html">PCI-DSS</a></li>
                      <li><a href="compliance_cmmc.html">CMMC L2</a></li>
                      <li><a href="compliance_iso27001.html">ISO 27001</a></li>
                    </ul>
                  </li>
                  <li><a href="evidence_vault.html"><i class="fas fa-archive"></i> Evidence Library</a></li>
                  <li><a href="remediation.html"><i class="fas fa-lightbulb"></i> Remediation Center</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Top Nav -->
        <div class="top_nav">
            <div class="nav_menu">
                <div class="nav toggle">
                  <a id="menu_toggle"><i class="fas fa-bars"></i></a>
                </div>
                <nav class="nav navbar-nav">
                <ul class="navbar-right">
                  <li class="nav-item dropdown open" style="padding-left: 15px;">
                    <a href="javascript:;" class="user-profile dropdown-toggle" aria-haspopup="true" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                      <img src="images/img.jpg" alt="">Admin User
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
        </div>

        <!-- Page Content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>Enterprise Risk Register</h3>
              </div>
            </div>

            <div class="clearfix"></div>

            <!-- Risk Heatmap -->
            <div class="row">
              <div class="col-md-6 col-sm-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h4>Risk Heatmap <small>(Likelihood vs Impact)</small></h4>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <table class="table table-bordered">
                      <thead>
                        <tr>
                          <th style="background: #f7f7f7;"></th>
                          <th class="text-center">Low Impact</th>
                          <th class="text-center">Med Impact</th>
                          <th class="text-center">High Impact</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <th class="align-middle">High Likelihood</th>
                          <td class="heatmap-cell bg-medium" id="cell-hl-li">0</td>
                          <td class="heatmap-cell bg-high" id="cell-hl-mi">0</td>
                          <td class="heatmap-cell bg-critical" id="cell-hl-hi">0</td>
                        </tr>
                        <tr>
                          <th class="align-middle">Med Likelihood</th>
                          <td class="heatmap-cell bg-low" id="cell-ml-li">0</td>
                          <td class="heatmap-cell bg-medium" id="cell-ml-mi">0</td>
                          <td class="heatmap-cell bg-high" id="cell-ml-hi">0</td>
                        </tr>
                        <tr>
                          <th class="align-middle">Low Likelihood</th>
                          <td class="heatmap-cell bg-low" id="cell-ll-li">0</td>
                          <td class="heatmap-cell bg-low" id="cell-ll-mi">0</td>
                          <td class="heatmap-cell bg-medium" id="cell-ll-hi">0</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Residual Risk Score -->
              <div class="col-md-6 col-sm-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h4>Residual Risk Overview</h4>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content text-center">
                    <div style="width: 200px; height: 160px; margin: 0 auto;">
                        <canvas id="riskGauge"></canvas>
                    </div>
                    <h2 id="residual-score">0</h2>
                    <p>Current Residual Risk Score</p>
                    <hr>
                    <div class="row">
                      <div class="col-4 border-end">
                        <h4 id="stat-total">0</h4>
                        <span class="text-muted">Total Risks</span>
                      </div>
                      <div class="col-4 border-end">
                        <h4 id="stat-mitigated" class="text-success">0</h4>
                        <span class="text-muted">Mitigated</span>
                      </div>
                      <div class="col-4">
                        <h4 id="stat-accepted" class="text-warning">0</h4>
                        <span class="text-muted">Accepted</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Risk Register Table -->
            <div class="row">
              <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h4>Top Priority Risks</h4>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Risk Title</th>
                          <th>Impact</th>
                          <th>Likelihood</th>
                          <th>Owner</th>
                          <th>Status</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody id="risk-table-body">
                        <!-- Populated by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
        <!-- /page content -->

        <footer>
          <div class="float-end">RISQIANT - Security Operations</div>
          <div class="clearfix"></div>
        </footer>
      </div>
    </div>

    <!-- Logic -->
    <script type="module">
      import { mockData } from '/src/api/mockData.js';

      function initRiskRegister() {
        const data = mockData.riskRegister;

        // 1. Populate Stats
        document.getElementById('residual-score').textContent = data.residualScore;
        document.getElementById('stat-total').textContent = data.totalRisks;
        document.getElementById('stat-mitigated').textContent = data.mitigated;
        document.getElementById('stat-accepted').textContent = data.accepted;

        // 2. Populate Heatmap (Simulated mapping)
        document.getElementById('cell-hl-hi').textContent = data.heatmap.critical;
        document.getElementById('cell-hl-mi').textContent = Math.floor(data.heatmap.high / 2);
        document.getElementById('cell-ml-hi').textContent = Math.ceil(data.heatmap.high / 2);
        document.getElementById('cell-ml-mi').textContent = data.heatmap.medium;
        // ... fill others with low/zeros for demo

        // 3. Populate Table
        const tbody = document.getElementById('risk-table-body');
        tbody.innerHTML = '';
        data.topRisks.forEach(risk => {
          const row = `<tr>
            <td><strong>${risk.id}</strong></td>
            <td>${risk.title}</td>
            <td><span class="badge ${getImpactBadge(risk.impact)}">${risk.impact}</span></td>
            <td>${risk.likelihood}</td>
            <td>${risk.owner}</td>
            <td>${risk.status}</td>
            <td><a href="#" class="btn btn-sm btn-light">Details</a></td>
          </tr>`;
          tbody.innerHTML += row;
        });

        // 4. Init Gauge
        initGauge(data.residualScore);
      }

      function getImpactBadge(impact) {
        if(impact === 'High') return 'bg-danger';
        if(impact === 'Medium') return 'bg-warning';
        return 'bg-success';
      }

      function initGauge(score) {
        const ctx = document.getElementById('riskGauge');
        if(!ctx) return;
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            datasets: [{
              data: [score, 100 - score],
              backgroundColor: ['#E74C3C', '#ECF0F1'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            cutout: '75%',
            plugins: { legend: { display: false }, tooltip: { enabled: false } }
          }
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        const check = setInterval(() => {
          if (typeof window.Chart !== 'undefined') {
            clearInterval(check);
            initRiskRegister();
          }
        }, 100);
      });
    </script>
  </body>
</html>